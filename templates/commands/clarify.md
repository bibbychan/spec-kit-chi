---
description: 透過提出最多 5 個高度目標化的澄清問題並將答案編碼回規格中，識別當前功能規格中規定不足的區域。
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## 使用者輸入

```text
$ARGUMENTS
```

您**必須**在繼續之前考慮使用者輸入（如果不為空）。

## 概要

目標：檢測並減少現行功能規格中的模糊性或缺失決策點，並直接在規格文件中記錄澄清。

注意：此澄清工作流程預期在調用 `/speckit.plan` 之前運行（並完成）。如果使用者明確表示他們跳過澄清（例如，探索性原型），您可以繼續，但必須警告下游重做風險增加。

執行步驟：

1. 從儲存庫根目錄執行 `{SCRIPT}` **一次**（組合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小的 JSON 載荷欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選捕獲 `IMPL_PLAN`、`TASKS` 用於未來鏈式流程。）
   - 如果 JSON 解析失敗，中止並指示使用者重新運行 `/speckit.specify` 或驗證功能分支環境。

2. 載入當前規格文件。使用此分類法執行結構化模糊性和覆蓋率掃描。對於每個類別，標記狀態：清晰 / 部分 / 缺失。產生用於優先排序的內部覆蓋率圖（除非不會提問，否則不輸出原始圖）。

   功能範圍與行為：
   - 核心使用者目標與成功標準
   - 明確的範圍外聲明
   - 使用者角色 / 角色區分

   領域與資料模型：
   - 實體、屬性、關係
   - 身份與唯一性規則
   - 生命週期/狀態轉換
   - 資料量 / 規模假設

   互動與 UX 流程：
   - 關鍵使用者旅程 / 序列
   - 錯誤/空/載入狀態
   - 無障礙或本地化註釋

   非功能性品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（水平/垂直、限制）
   - 可靠性與可用性（正常運行時間、恢復期望）
   - 可觀測性（日誌記錄、指標、追蹤信號）
   - 安全與隱私（身份驗證/授權、資料保護、威脅假設）
   - 合規 / 監管約束（如果有的話）

   整合與外部依賴：
   - 外部服務/API 和故障模式
   - 資料匯入/匯出格式
   - 協議/版本控制假設

   邊緣情況與故障處理：
   - 負面場景
   - 速率限制 / 節流
   - 衝突解決（例如，並發編輯）

   約束與權衡：
   - 技術約束（語言、儲存、託管）
   - 明確的權衡或拒絕的替代方案

   術語與一致性：
   - 標準詞彙表術語
   - 避免的同義詞 / 已廢棄術語

   完成信號：
   - 驗收標準可測試性
   - 可衡量的完成定義樣式指標

   雜項 / 佔位符：
   - TODO 標記 / 未解決的決策
   - 缺乏量化的模糊形容詞（"強大"、"直觀"）

   對於每個狀態為部分或缺失的類別，添加候選問題機會，除非：
   - 澄清不會實質性改變實作或驗證策略
   - 資訊最好延遲到規劃階段（內部註釋）

3. 生成（內部）候選澄清問題的優先佇列（最多 5 個）。不要一次輸出所有問題。應用這些約束：
    - 整個會話最多 10 個總問題。
    - 每個問題必須可以用以下任一方式回答：
       * 短選擇題（2-5 個不同、互斥的選項），或
       * 單詞 / 短語答案（明確約束："答案 <=5 個詞"）。
    - 只包括其答案實質性影響架構、資料建模、任務分解、測試設計、UX 行為、運行準備度或合規驗證的問題。
    - 確保類別覆蓋率平衡：嘗試首先覆蓋最高影響的未解決類別；避免在單個高影響區域（例如，安全姿態）未解決時詢問兩個低影響問題。
    - 排除已回答的問題、瑣碎的樣式偏好或計畫級別執行細節（除非阻止正確性）。
    - 偏好減少下游重做風險或防止錯位驗收測試的澄清。
    - 如果超過 5 個類別仍未解決，請按（影響 * 不確定性）啟發式選擇前 5 個。

4. 順序提問循環（互動）：
    - 一次只呈現**一個**問題。
    - 對於選擇題，將選項渲染為 Markdown 表格：

       | 選項 | 描述 |
       |--------|-------------|
       | A | <選項 A 描述> |
       | B | <選項 B 描述> |
       | C | <選項 C 描述> | （根據需要添加 D/E 最多 5 個）
       | 短答案 | 提供不同的短答案（<=5 個詞） | （僅在自由形式替代方案適當時包括）

    - 對於短答案樣式（無有意義的離散選項），在問題後輸出單行：`格式：短答案（<=5 個詞）`。
    - 使用者回答後：
       * 驗證答案映射到一個選項或符合 <=5 個詞約束。
       * 如果模糊，要求快速消除歧義（計數仍屬於同一問題；不要前進）。
       * 一旦滿意，將其記錄在工作記憶體中（還不要寫入磁盤）並移動到下一個排隊的問題。
    - 在以下情況停止進一步提問：
       * 所有關鍵模糊性早期解決（剩餘排隊項目變得不必要），或
       * 使用者發出完成信號（"完成"、"好"、"不再"），或
       * 您達到 5 個已提問問題。
    - 永遠不要提前揭示未來排隊的問題。
    - 如果開始時沒有有效問題，立即報告沒有關鍵模糊性。

5. 每個接受答案後的整合（增量更新方法）：
    - 維護規格的記憶體中表示（開始時載入一次）加上原始文件內容。
    - 對於此會話中的第一個整合答案：
       * 確保存在 `## 澄清` 部分（如果缺失，在規格範本的最高級別上下文/概覽部分之後創建它）。
       * 在其下，創建（如果不存在）今天的 `### 會話 YYYY-MM-DD` 子標題。
    - 在接受後立即附加項目符號行：`- 問：<問題> → 答：<最終答案>`。
    - 然後立即將澄清應用於最適當的部分：
       * 功能模糊性 → 更新或在功能需求中添加項目符號。
       * 使用者互動 / 行為者區分 → 使用澄清的角色、約束或場景更新使用者故事或行為者子部分（如果存在）。
       * 資料形狀 / 實體 → 更新資料模型（添加欄位、類型、關係）保持順序；簡潔地註釋添加的約束。
       * 非功能性約束 → 在非功能性 / 品質屬性部分添加/修改可衡量標準（將模糊形容詞轉換為指標或明確目標）。
       * 邊緣情況 / 負面流程 → 在邊緣情況 / 錯誤處理下添加新項目符號（或如果範本為其提供佔位符則創建此類子部分）。
       * 術語衝突 → 在整個規格中標準化術語；僅在必要時通過添加一次 `(以前稱為 "X")` 保留原始。
    - 如果澄清使早期的模糊陳述無效，請替換該陳述而不是複製；不要留下過時的矛盾文本。
    - 在每次整合後保存規格文件以最小化上下文丟失風險（原子覆蓋）。
    - 保留格式：不要重新排序不相關的部分；保持標題層次完整。
    - 保持每個插入的澄清最小化和可測試（避免敘述漂移）。

6. 驗證（每次寫入後加上最終通過時執行）：
   - 澄清會話包含每個接受答案恰好一個項目符號（無重複）。
   - 總提問（接受）問題 ≤ 5。
   - 更新的部分沒有新答案要解決的持續模糊佔位符。
   - 沒有矛盾的早期陳述保留（掃描移除的現在無效的替代選擇）。
   - Markdown 結構有效；只允許新標題：`## 澄清`、`### 會話 YYYY-MM-DD`。
   - 術語一致性：在所有更新部分使用相同的標準術語。

7. 將更新的規格寫回 `FEATURE_SPEC`。

8. 報告完成（提問循環結束或提前終止後）：
   - 提問和回答的問題數量。
   - 更新規格的路徑。
   - 接觸的部分（列出名稱）。
   - 覆蓋率摘要表，列出每個分類類別的狀態：已解決（曾是部分/缺失並已處理）、延遲（超過問題配額或更適合規劃）、清晰（已足夠）、突出（仍然部分/缺失但影響低）。
   - 如果任何突出或延遲仍然存在，建議是否繼續到 `/speckit.plan` 或在規劃後再次運行 `/speckit.clarify`。
   - 建議的下一個命令。

行為規則：
- 如果沒有發現有意義的模糊性（或所有潛在問題都是低影響的），回應：「沒有檢測到值得正式澄清的關鍵模糊性。」並建議繼續。
- 如果規格文件缺失，指示使用者首先運行 `/speckit.specify`（不要在此創建新規格）。
- 永遠不要超過 5 個總提問問題（單個問題的澄清重試不算作新問題）。
- 避免投機性技術堆疊問題，除非缺失阻止功能清晰性。
- 尊重使用者提前終止信號（"停止"、"完成"、"繼續"）。
- 如果由於完整覆蓋而沒有提問，輸出緊湊的覆蓋率摘要（所有類別清晰）然後建議前進。
- 如果配額達到但未解決的高影響類別仍然存在，在延遲下明確標記它們並附上理由。

優先排序的上下文：{ARGS}